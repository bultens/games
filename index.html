<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snake Game</title>
    <!-- Tailwind CSS för en responsiv och modern design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Importerar Google Font "Inter" */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
    </style>
</head>
<body class="bg-[#2c3e50] text-[#ecf0f1] font-inter flex flex-col items-center justify-center min-h-screen p-4 box-border">
    <h1 class="text-4xl sm:text-5xl font-bold mb-6 text-white">Snake</h1>

    <!-- Huvudbehållare: responsiv flexbox som staplar på små skärmar och lägger sidorna om på större -->
    <div class="flex flex-col lg:flex-row items-center lg:items-start gap-8 lg:gap-12 w-full max-w-7xl">

        <!-- Behållare för spelet -->
        <div id="game-container" class="relative bg-[#34495e] rounded-xl shadow-2xl p-6 flex flex-col items-center gap-4 w-full lg:w-3/5">
            <canvas id="gameCanvas" class="bg-[#2c3e50] border-4 border-[#7f8c8d] rounded-lg shadow-inner w-full max-w-lg aspect-square"></canvas>
            
            <div id="score-container" class="text-2xl font-bold text-[#f1c40f]">Poäng: <span id="score">0</span></div>
            
            <button id="startButton" class="bg-[#3498db] hover:bg-[#2980b9] text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all duration-300 transform hover:-translate-y-1 active:translate-y-0 active:shadow-md">Starta spel</button>
            
            <p id="controls-info" class="text-sm text-[#bdc3c7] mt-2">Tryck på "Starta spel" och styr med piltangenterna.</p>
        </div>

        <!-- Behållare för topplistan -->
        <div id="highscore-container" class="bg-[#34495e] p-6 rounded-xl shadow-2xl w-full lg:w-2/5">
            <h2 class="text-3xl font-bold text-[#f1c40f] mb-4">Topplista</h2>
            <ol id="highscore-list" class="list-none p-0 m-0">
                <!-- Poängen kommer att visas här dynamiskt via JavaScript -->
                <li class="bg-[#2c3e50] p-3 rounded-lg mb-2 flex justify-between items-center text-lg shadow">Laddar poäng...</li>
            </ol>
        </div>
    </div>

    <!-- Samlad JavaScript för all spel- och databaslogik -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp, query, orderBy, limit, getDocs, where, updateDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Globala variabler från Canvas-miljön
        const canvasFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const canvasAppId = typeof __app_id !== 'undefined' ? __app_id : null;
        const canvasAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Klistra in din egen Firebase-konfiguration här för att köra spelet utanför Canvas-miljön ---
        // Du hittar denna information i ditt Firebase-projekt under "Project settings" -> "Your apps".
        // Om du kör i Canvas, kommer den här konfigurationen att ignoreras.
        const customFirebaseConfig = {
            apiKey: "AIzaSyA_E4M8WPU3qrrWtW8fOkSJEM46sylRyzk",
            authDomain: "snake-6dbce.firebaseapp.com",
            projectId: "snake-6dbce",
            storageBucket: "snake-6dbce.firebasestorage.app",
            messagingSenderId: "322128334339",
            appId: "1:322128334339:web:f9815a73fb71ab75eb8836",
            measurementId: "G-QS1QW6ZZJ0"
        };
        // ------------------------------------------------------------------------------------------

        // Använd Canvas-konfiguration om den finns, annars den anpassade
        const firebaseConfig = canvasFirebaseConfig || customFirebaseConfig;
        const appId = canvasAppId || customFirebaseConfig.appId;

        // Initiera Firebase
        let app;
        let auth;
        let db;
        let highscoresCollection;

        function initializeFirebase() {
            try {
                if (!firebaseConfig.projectId || firebaseConfig.projectId === "DITT_PROJEKT_ID_HÄR") {
                     console.error("Firebase-konfiguration saknas. Vänligen klistra in din konfiguration för att spelet ska fungera på GitHub.");
                     return false;
                }
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                highscoresCollection = collection(db, `artifacts/${appId}/public/data/highscores`);
                return true;
            } catch (e) {
                console.error("Kunde inte initiera Firebase:", e);
                return false;
            }
        }

        // Autentiserar användaren
        async function authenticate() {
            try {
                if (canvasAuthToken) {
                    await signInWithCustomToken(auth, canvasAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Autentisering misslyckades", error);
            }
        }
        
        // Spelkonstanter
        const CANVAS_SIZE = 400; 
        const GRID_SIZE = 20;
        const CELL_SIZE = CANVAS_SIZE / GRID_SIZE;
        const INITIAL_SPEED = 150;
        const SPEED_INCREMENT = 5;

        // Speltillståndsvariabler
        let snake = [];
        let food = {};
        let direction = { x: 1, y: 0 };
        let score = 0;
        let gameSpeed = INITIAL_SPEED;
        let gameLoop = null;
        let isGameOver = false;
        let isGameStarted = false;
        let isSavingScore = false;

        // Hämta DOM-element
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        const startButton = document.getElementById('startButton');
        const controlsInfo = document.getElementById('controls-info');
        const highscoreList = document.getElementById('highscore-list');
        const gameContainer = document.getElementById('game-container');

        // Ställ in canvas-dimensioner
        canvas.width = CANVAS_SIZE;
        canvas.height = CANVAS_SIZE;

        // --- Databasfunktioner ---
        
        // Lyssnar på ändringar i databasen och uppdaterar topplistan
        function loadHighScores() {
            if (!db) {
                console.warn("Firebase är inte initialiserat. Topplistan kan inte laddas.");
                return;
            }
            const q = query(highscoresCollection, orderBy('score', 'desc'), limit(10));
            onSnapshot(q, (querySnapshot) => {
                const scores = [];
                querySnapshot.forEach((doc) => {
                    scores.push({ ...doc.data(), id: doc.id });
                });
                renderHighScores(scores);
            }, (error) => {
                console.error("Fel vid laddning av poäng:", error);
            });
        }

        // Sparar en ny poäng i databasen
        async function saveHighScore(name, userScore) {
            if (!db || isSavingScore || userScore === 0) return;
            isSavingScore = true;
            try {
                // Skapa en fråga för att se om spelaren redan finns
                const q = query(highscoresCollection, where("name", "==", name));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    // Om spelaren finns, uppdatera poängen om den nya poängen är högre
                    const existingDoc = querySnapshot.docs[0];
                    if (userScore > existingDoc.data().score) {
                        const docRef = doc(db, highscoresCollection.path, existingDoc.id);
                        await updateDoc(docRef, {
                            score: userScore,
                            timestamp: serverTimestamp()
                        });
                        console.log("Poäng uppdaterad!");
                    } else {
                        console.log("Ny poäng är inte högre, poängen uppdaterades inte.");
                    }
                } else {
                    // Om spelaren inte finns, skapa en ny post
                    await addDoc(highscoresCollection, {
                        name: name,
                        score: userScore,
                        timestamp: serverTimestamp()
                    });
                    console.log("Ny poäng sparad!");
                }
            } catch (e) {
                console.error("Fel vid sparande av poäng:", e);
            } finally {
                isSavingScore = false;
            }
        }


        // Renderar topplistan i HTML
        function renderHighScores(scores) {
            highscoreList.innerHTML = '';
            if (scores.length === 0) {
                const li = document.createElement('li');
                li.className = 'bg-[#2c3e50] p-3 rounded-lg mb-2 text-lg text-center shadow';
                li.innerText = 'Inga poäng än';
                highscoreList.appendChild(li);
                return;
            }
            scores.forEach((scoreData, index) => {
                const li = document.createElement('li');
                let colorClass = 'text-white';
                if (index === 0) colorClass = 'text-yellow-400';
                else if (index === 1) colorClass = 'text-gray-400';
                else if (index === 2) colorClass = 'text-amber-700';

                li.className = `bg-[#2c3e50] p-3 rounded-lg mb-2 flex justify-between items-center text-lg font-bold shadow ${colorClass}`;
                li.innerHTML = `<span>${scoreData.name}</span><span>${scoreData.score}</span>`;
                highscoreList.appendChild(li);
            });
        }

        // --- Spellogikfunktioner ---

        // Initierar spelets tillstånd
        function initializeGame() {
            snake = [{ x: 10, y: 10 }];
            food = generateFood();
            direction = { x: 1, y: 0 };
            score = 0;
            gameSpeed = INITIAL_SPEED;
            isGameOver = false;
            scoreElement.innerText = score;
            startButton.innerText = 'Starta spel';
            controlsInfo.style.display = 'block';
            
            const scoreForm = document.getElementById('score-form');
            if (scoreForm) {
                scoreForm.remove();
            }
            render();
        }

        // Genererar mat på en slumpmässig plats
        function generateFood() {
            let newFood;
            do {
                newFood = {
                    x: Math.floor(Math.random() * GRID_SIZE),
                    y: Math.floor(Math.random() * GRID_SIZE)
                };
            } while (isPositionOnSnake(newFood));
            return newFood;
        }

        // Kontrollerar om en position är på ormen
        function isPositionOnSnake(pos) {
            return snake.some(segment => segment.x === pos.x && segment.y === pos.y);
        }

        // Huvuduppdateringsfunktion för spelet
        function update() {
            if (isGameOver) {
                return;
            }

            const head = { x: snake[0].x + direction.x, y: snake[0].y + direction.y };

            if (
                head.x < 0 || head.x >= GRID_SIZE ||
                head.y < 0 || head.y >= GRID_SIZE ||
                isPositionOnSnake(head)
            ) {
                endGame();
                return;
            }

            snake.unshift(head);

            if (head.x === food.x && head.y === food.y) {
                score++;
                scoreElement.innerText = score;
                food = generateFood();
                gameSpeed = Math.max(50, gameSpeed - SPEED_INCREMENT);
                clearInterval(gameLoop);
                gameLoop = setInterval(update, gameSpeed);
            } else {
                snake.pop();
            }

            render();
        }

        // Renderar spelets tillstånd på canvas
        function render() {
            ctx.clearRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);

            ctx.fillStyle = '#e74c3c';
            ctx.fillRect(food.x * CELL_SIZE, food.y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
            
            snake.forEach((segment, index) => {
                ctx.fillStyle = index === 0 ? '#1abc9c' : '#16a085';
                ctx.fillRect(segment.x * CELL_SIZE, segment.y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
                ctx.strokeStyle = '#2c3e50';
                ctx.strokeRect(segment.x * CELL_SIZE, segment.y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
            });
        }

        // Avslutar spelet och visar formulär för poäng
        function endGame() {
            isGameOver = true;
            isGameStarted = false;
            clearInterval(gameLoop);
            startButton.innerText = 'Spela igen';
            showScoreForm(score);
        }

        // Visar formuläret för att spara poängen
        function showScoreForm(finalScore) {
            let scoreForm = document.getElementById('score-form');
            if (!scoreForm) {
                scoreForm = document.createElement('div');
                scoreForm.id = 'score-form';
                scoreForm.className = 'flex flex-col gap-4 mt-5';
                scoreForm.innerHTML = `
                    <div class="text-xl font-semibold">Bra jobbat! Din poäng är: ${finalScore}</div>
                    <input type="text" id="playerName" placeholder="Skriv in ditt namn" required class="p-3 rounded-lg border border-[#7f8c8d] bg-[#2c3e50] text-[#ecf0f1] focus:outline-none focus:ring-2 focus:ring-[#3498db]">
                    <button id="saveScoreButton" class="w-full bg-[#3498db] hover:bg-[#2980b9] text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300">Spara poäng</button>
                `;
                gameContainer.appendChild(scoreForm);

                document.getElementById('saveScoreButton').addEventListener('click', async () => {
                    const playerNameInput = document.getElementById('playerName');
                    const name = playerNameInput.value.trim();
                    if (name) {
                        await saveHighScore(name, finalScore);
                        scoreForm.remove();
                        isGameStarted = false; 
                        startButton.innerText = 'Starta spel';
                        controlsInfo.style.display = 'block';
                    } else {
                        playerNameInput.classList.add('border-red-500');
                    }
                });
            }
        }

        // --- Händelselyssnare och spelinitiering ---

        // Hanterar tangentbordsinmatning
        function handleKeydown(event) {
            // Kontrollera om spelet är igång och inte över
            if (!isGameStarted || isGameOver) return;
            
            const key = event.key;
            let newDirection = { x: direction.x, y: direction.y };

            switch (key) {
                case 'ArrowUp':
                    if (direction.y !== 1) { newDirection = { x: 0, y: -1 }; }
                    break;
                case 'ArrowDown':
                    if (direction.y !== -1) { newDirection = { x: 0, y: 1 }; }
                    break;
                case 'ArrowLeft':
                    if (direction.x !== 1) { newDirection = { x: -1, y: 0 }; }
                    break;
                case 'ArrowRight':
                    if (direction.x !== -1) { newDirection = { x: 1, y: 0 }; }
                    break;
            }
            // Uppdatera endast om det är en ny, giltig riktning
            if (newDirection.x !== direction.x || newDirection.y !== direction.y) {
                 direction = newDirection;
            }
        }

        // Startknappens hanterare
        startButton.addEventListener('click', () => {
            // Starta eller starta om spelet om det inte är igång
            if (!isGameStarted) {
                isGameStarted = true;
                initializeGame();
                startButton.innerText = 'Spelar...';
                controlsInfo.style.display = 'none';
                gameLoop = setInterval(update, gameSpeed);
            } else if (isGameOver) {
                 // Om spelet är slut, starta om
                isGameStarted = true;
                initializeGame();
                gameLoop = setInterval(update, gameSpeed);
                startButton.innerText = 'Spelar...';
                controlsInfo.style.display = 'none';
            }
        });

        // Lägger till händelselyssnare
        document.addEventListener('keydown', handleKeydown);

        // Körs när fönstret laddats
        window.onload = function() {
            if (initializeFirebase()) {
                authenticate().then(() => {
                    loadHighScores();
                    initializeGame();
                });
            } else {
                // Visa ett meddelande till användaren om Firebase-konfigurationen saknas
                const highscoreContainer = document.getElementById('highscore-container');
                const errorMessage = document.createElement('p');
                errorMessage.className = 'text-center text-red-500 mt-4 font-bold';
                errorMessage.innerText = 'Kan inte ladda topplistan. Vänligen lägg till din Firebase-konfiguration i koden.';
                highscoreContainer.appendChild(errorMessage);
            }
        };
    </script>
</body>
</html>
