<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snake Game</title>
    <!-- Använd Tailwind CSS för styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');

        /* Global styling för bakgrund och typsnitt */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #2c3e50;
            color: #ecf0f1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        /* Huvudrubrik */
        h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
        }

        /* Huvudbehållare för spel och topplista, flexbox för responsiv layout */
        #main-container {
            display: flex;
            gap: 40px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-start;
        }

        /* Spelbehållaren med skugga och rundade hörn */
        #game-container {
            position: relative;
            background-color: #34495e;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        /* Canvas för spelet */
        canvas {
            background-color: #2c3e50;
            border: 3px solid #7f8c8d;
            border-radius: 10px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 400px;
            height: auto;
            aspect-ratio: 1 / 1;
        }

        /* Behållare för poängvisning */
        #score-container {
            font-size: 1.5rem;
            font-weight: bold;
            color: #f1c40f;
        }

        /* Styling för alla knappar */
        button {
            padding: 12px 25px;
            font-size: 1.1rem;
            font-weight: bold;
            color: #fff;
            background-color: #3498db;
            border: 2px solid #556a7d; /* Lade till en ram för att synas bättre */
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        button:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Text för kontrollinstruktioner */
        #controls-info {
            font-size: 0.9rem;
            color: #bdc3c7;
            margin-top: 10px;
        }

        /* Behållare för topplistan */
        #highscore-container {
            background-color: #34495e;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 300px;
        }

        #highscore-container h2 {
            font-size: 1.8rem;
            font-weight: bold;
            color: #f1c40f;
            margin-bottom: 15px;
        }

        #highscore-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #highscore-list li {
            background-color: #2c3e50;
            margin-bottom: 8px;
            padding: 10px 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            font-size: 1.1rem;
        }

        #highscore-list li:nth-child(1) { color: #ffd700; }
        #highscore-list li:nth-child(2) { color: #c0c0c0; }
        #highscore-list li:nth-child(3) { color: #cd7f32; }

        /* Formulär för att spara poäng */
        .score-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .score-form input {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #7f8c8d;
            background-color: #2c3e50;
            color: #ecf0f1;
            font-size: 1rem;
        }

        .score-form button {
            width: 100%;
        }
    </style>
    <!-- Firebase imports för databasfunktionalitet -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, getDocs, query, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Globala variabler för Firebase, hämtas från Canvas-miljön
        window.firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        window.authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';

        // Initiera Firebase
        window.app = initializeApp(window.firebaseConfig);
        window.auth = getAuth(window.app);
        window.db = getFirestore(window.app);

        // Skapa en referens till highscore-samlingen
        window.highscoresCollection = collection(window.db, `artifacts/${window.appId}/public/data/highscores`);

        // Logga in användaren
        async function authenticate() {
            try {
                if (window.authToken) {
                    await signInWithCustomToken(window.auth, window.authToken);
                } else {
                    await signInAnonymously(window.auth);
                }
            } catch (error) {
                console.error("Autentisering misslyckades", error);
            }
        }
        window.authenticate = authenticate;
    </script>
</head>
<body>
    <h1>Snake</h1>
    <div id="main-container">
        <div id="game-container">
            <canvas id="gameCanvas"></canvas>
            <div id="score-container">Poäng: <span id="score">0</span></div>
            <button id="startButton">Starta spel</button>
            <p id="controls-info">Tryck på "Starta spel" och styr med piltangenterna.</p>
        </div>
        <div id="highscore-container">
            <h2>Topplista</h2>
            <ol id="highscore-list">
                <!-- Poängen kommer att visas här dynamiskt via JavaScript -->
                <li>Laddar poäng...</li>
            </ol>
        </div>
    </div>

    <script type="module">
        import { onSnapshot, addDoc, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Spelkonstanter
        const CANVAS_SIZE = 400; 
        const GRID_SIZE = 20;
        const CELL_SIZE = CANVAS_SIZE / GRID_SIZE;
        const INITIAL_SPEED = 150;
        const SPEED_INCREMENT = 5;

        // Speltillståndsvariabler
        let snake = [];
        let food = {};
        let direction = { x: 1, y: 0 };
        let score = 0;
        let gameSpeed = INITIAL_SPEED;
        let gameLoop = null;
        let isGameOver = false;
        let isGameStarted = false;
        let isSavingScore = false;

        // Hämta DOM-element
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        const startButton = document.getElementById('startButton');
        const controlsInfo = document.getElementById('controls-info');
        const highscoreList = document.getElementById('highscore-list');
        const gameContainer = document.getElementById('game-container');

        // Ställ in canvas-dimensioner
        canvas.width = CANVAS_SIZE;
        canvas.height = CANVAS_SIZE;

        // --- Databasfunktioner ---
        
        // Lyssnar på ändringar i databasen och uppdaterar topplistan
        function loadHighScores() {
            onSnapshot(window.highscoresCollection, (querySnapshot) => {
                const scores = [];
                querySnapshot.forEach((doc) => {
                    scores.push({ ...doc.data(), id: doc.id });
                });
                scores.sort((a, b) => b.score - a.score);
                const top10 = scores.slice(0, 10);
                renderHighScores(top10);
            }, (error) => {
                console.error("Fel vid laddning av poäng:", error);
            });
        }

        // Sparar en ny poäng i databasen
        async function saveHighScore(name, userScore) {
            if (isSavingScore || userScore === 0) return;
            isSavingScore = true;
            try {
                await addDoc(window.highscoresCollection, {
                    name: name,
                    score: userScore,
                    timestamp: serverTimestamp()
                });
                console.log("Poäng sparad!");
            } catch (e) {
                console.error("Fel vid sparande av poäng:", e);
            } finally {
                isSavingScore = false;
            }
        }

        // Renderar topplistan i HTML
        function renderHighScores(scores) {
            highscoreList.innerHTML = '';
            if (scores.length === 0) {
                const li = document.createElement('li');
                li.innerText = 'Inga poäng än';
                highscoreList.appendChild(li);
                return;
            }
            scores.forEach(scoreData => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${scoreData.name}</span><span>${scoreData.score}</span>`;
                highscoreList.appendChild(li);
            });
        }

        // --- Spellogikfunktioner ---

        // Initierar spelets tillstånd
        function initializeGame() {
            snake = [{ x: 10, y: 10 }];
            food = generateFood();
            direction = { x: 1, y: 0 };
            score = 0;
            gameSpeed = INITIAL_SPEED;
            isGameOver = false;
            isGameStarted = false;
            scoreElement.innerText = score;
            startButton.innerText = 'Starta spel';
            controlsInfo.style.display = 'block';
            
            const scoreForm = document.getElementById('score-form');
            if (scoreForm) {
                scoreForm.remove();
            }
            render();
        }

        // Genererar mat på en slumpmässig plats
        function generateFood() {
            let newFood;
            do {
                newFood = {
                    x: Math.floor(Math.random() * GRID_SIZE),
                    y: Math.floor(Math.random() * GRID_SIZE)
                };
            } while (isPositionOnSnake(newFood));
            return newFood;
        }

        // Kontrollerar om en position är på ormen
        function isPositionOnSnake(pos) {
            return snake.some(segment => segment.x === pos.x && segment.y === pos.y);
        }

        // Huvuduppdateringsfunktion för spelet
        function update() {
            if (isGameOver) {
                return;
            }

            const head = { x: snake[0].x + direction.x, y: snake[0].y + direction.y };

            if (
                head.x < 0 || head.x >= GRID_SIZE ||
                head.y < 0 || head.y >= GRID_SIZE ||
                isPositionOnSnake(head)
            ) {
                endGame();
                return;
            }

            snake.unshift(head);

            if (head.x === food.x && head.y === food.y) {
                score++;
                scoreElement.innerText = score;
                food = generateFood();
                gameSpeed = Math.max(50, gameSpeed - SPEED_INCREMENT);
                clearInterval(gameLoop);
                gameLoop = setInterval(update, gameSpeed);
            } else {
                snake.pop();
            }

            render();
        }

        // Renderar spelets tillstånd på canvas
        function render() {
            ctx.clearRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);

            ctx.fillStyle = '#e74c3c';
            ctx.fillRect(food.x * CELL_SIZE, food.y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
            
            snake.forEach((segment, index) => {
                ctx.fillStyle = index === 0 ? '#1abc9c' : '#16a085';
                ctx.fillRect(segment.x * CELL_SIZE, segment.y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
                ctx.strokeStyle = '#2c3e50';
                ctx.strokeRect(segment.x * CELL_SIZE, segment.y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
            });
        }

        // Avslutar spelet och visar formulär för poäng
        function endGame() {
            isGameOver = true;
            clearInterval(gameLoop);
            startButton.innerText = 'Spela igen';
            showScoreForm(score);
        }

        // Visar formuläret för att spara poängen
        function showScoreForm(finalScore) {
            let scoreForm = document.getElementById('score-form');
            if (!scoreForm) {
                scoreForm = document.createElement('div');
                scoreForm.id = 'score-form';
                scoreForm.className = 'score-form';
                scoreForm.innerHTML = `
                    <p>Bra jobbat! Din poäng är: ${finalScore}</p>
                    <input type="text" id="playerName" placeholder="Skriv in ditt namn" required>
                    <button id="saveScoreButton">Spara poäng</button>
                `;
                gameContainer.appendChild(scoreForm);

                document.getElementById('saveScoreButton').addEventListener('click', async () => {
                    const playerNameInput = document.getElementById('playerName');
                    const name = playerNameInput.value.trim();
                    if (name) {
                        await saveHighScore(name, finalScore);
                        scoreForm.remove();
                        isGameStarted = false; 
                    } else {
                        playerNameInput.style.border = '2px solid red';
                    }
                });
            }
        }

        // --- Händelselyssnare och spelinitiering ---

        // Hanterar tangentbordsinmatning
        function handleKeydown(event) {
            if (!isGameStarted || isGameOver) return;
            
            const key = event.key;
            const newDirection = { x: direction.x, y: direction.y };

            switch (key) {
                case 'ArrowUp':
                    if (direction.y !== 1) { newDirection.x = 0; newDirection.y = -1; }
                    break;
                case 'ArrowDown':
                    if (direction.y !== -1) { newDirection.x = 0; newDirection.y = 1; }
                    break;
                case 'ArrowLeft':
                    if (direction.x !== 1) { newDirection.x = -1; newDirection.y = 0; }
                    break;
                case 'ArrowRight':
                    if (direction.x !== -1) { newDirection.x = 1; newDirection.y = 0; }
                    break;
            }
            direction = newDirection;
        }

        // Startknappens hanterare
        startButton.addEventListener('click', () => {
            if (!isGameStarted) {
                isGameStarted = true;
                initializeGame();
                startButton.innerText = 'Spelar...';
                controlsInfo.style.display = 'none';
                gameLoop = setInterval(update, gameSpeed);
            }
        });

        // Lägger till händelselyssnare
        document.addEventListener('keydown', handleKeydown);

        // Körs när fönstret laddats
        window.onload = function() {
            window.authenticate().then(() => {
                loadHighScores();
                initializeGame();
            });
        };
    </script>
</body>
</html>
