<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snake Game</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #2c3e50;
            color: #ecf0f1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
        }

        #game-container {
            position: relative;
            background-color: #34495e;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        canvas {
            background-color: #2c3e50;
            border: 3px solid #7f8c8d;
            border-radius: 10px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 400px;
            height: auto;
            aspect-ratio: 1 / 1;
        }

        #score-container {
            font-size: 1.5rem;
            font-weight: bold;
            color: #f1c40f;
        }

        button {
            padding: 12px 25px;
            font-size: 1.1rem;
            font-weight: bold;
            color: #fff;
            background-color: #3498db;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        button:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        #controls-info {
            font-size: 0.9rem;
            color: #bdc3c7;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>Snake</h1>
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="score-container">Poäng: <span id="score">0</span></div>
        <button id="startButton">Starta spel</button>
        <p id="controls-info">Tryck på "Starta spel" och styr med piltangenterna.</p>
    </div>

    <script>
        // Spelkonstanter
        const CANVAS_SIZE = 400; // Total storlek på canvas i pixlar
        const GRID_SIZE = 20; // Antal rutnätsceller (t.ex. 20x20)
        const CELL_SIZE = CANVAS_SIZE / GRID_SIZE; // Storlek på varje cell
        const INITIAL_SPEED = 150; // Initial spelhastighet i millisekunder (lägre är snabbare)
        const SPEED_INCREMENT = 5; // Hur mycket hastigheten minskar varje gång ormen äter

        // Speltillståndsvariabler
        let snake = [];
        let food = {};
        let direction = { x: 1, y: 0 }; 
        let score = 0;
        let gameSpeed = INITIAL_SPEED;
        let gameLoop = null;
        let isGameOver = false;
        let isGameStarted = false;

        // Hämta DOM-element
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        const startButton = document.getElementById('startButton');

        // Ställ in canvas-dimensioner
        canvas.width = CANVAS_SIZE;
        canvas.height = CANVAS_SIZE;

        // --- Spellogikfunktioner ---

        // Initiera spelets tillstånd
        function initializeGame() {
            snake = [{ x: 10, y: 10 }]; // Starta med ett ormsegment i mitten
            food = generateFood();
            direction = { x: 1, y: 0 }; // Återställ riktning vid omstart
            score = 0;
            gameSpeed = INITIAL_SPEED;
            isGameOver = false;
            isGameStarted = false; // VIKTIG FIX: isGameStarted ska vara false vid initialisering
            scoreElement.innerText = score;
            startButton.innerText = 'Starta spel';
            render();
        }

        // Generera ny mat på en slumpmässig position
        function generateFood() {
            let newFood;
            do {
                newFood = {
                    x: Math.floor(Math.random() * GRID_SIZE),
                    y: Math.floor(Math.random() * GRID_SIZE)
                };
            } while (isPositionOnSnake(newFood)); // Se till att mat inte hamnar på ormen
            return newFood;
        }

        // Kontrollera om en given position är på ormens kropp
        function isPositionOnSnake(pos) {
            return snake.some(segment => segment.x === pos.x && segment.y === pos.y);
        }

        // Huvudfunktion för speluppdatering (anropas i en loop)
        function update() {
            if (isGameOver) {
                return;
            }

            // Flytta ormen genom att skapa ett nytt huvud
            const head = { x: snake[0].x + direction.x, y: snake[0].y + direction.y };

            // Kontrollera om spelet är över
            if (
                head.x < 0 || head.x >= GRID_SIZE || // Kollision med vägg
                head.y < 0 || head.y >= GRID_SIZE ||
                isPositionOnSnake(head) // Kollision med sig själv
            ) {
                endGame();
                return;
            }

            // Lägg till det nya huvudet i början av ormens array
            snake.unshift(head);

            // Kontrollera om ormen åt maten
            if (head.x === food.x && head.y === food.y) {
                score++;
                scoreElement.innerText = score;
                food = generateFood();
                // Öka hastigheten
                gameSpeed = Math.max(50, gameSpeed - SPEED_INCREMENT);
                // Starta om spelets loop med den nya hastigheten
                clearInterval(gameLoop);
                gameLoop = setInterval(update, gameSpeed);
            } else {
                // Annars, ta bort svansen för att simulera rörelse
                snake.pop();
            }

            render();
        }

        // Rita spelets tillstånd på canvas
        function render() {
            // Rensa canvas
            ctx.clearRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);

            // Rita maten
            ctx.fillStyle = '#e74c3c';
            ctx.fillRect(food.x * CELL_SIZE, food.y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
            
            // Rita ormen
            snake.forEach((segment, index) => {
                ctx.fillStyle = index === 0 ? '#1abc9c' : '#16a085'; // Huvudet har en annan färg
                ctx.fillRect(segment.x * CELL_SIZE, segment.y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
                ctx.strokeStyle = '#2c3e50'; // Kantlinje för segmenten
                ctx.strokeRect(segment.x * CELL_SIZE, segment.y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
            });
        }

        // Avsluta spelet och visa ett meddelande
        function endGame() {
            isGameOver = true;
            isGameStarted = false;
            clearInterval(gameLoop);
            startButton.innerText = 'Spela igen';
            alertMessage('Game Over!', `Dina poäng: ${score}`);
        }

        // Anpassad varningsfunktion eftersom window.alert() är blockerad
        function alertMessage(title, message) {
            const container = document.getElementById('game-container');
            let messageBox = document.getElementById('messageBox');
            
            if (!messageBox) {
                messageBox = document.createElement('div');
                messageBox.id = 'messageBox';
                messageBox.style.cssText = `
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background-color: rgba(44, 62, 80, 0.95);
                    color: #ecf0f1;
                    padding: 30px;
                    border-radius: 15px;
                    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
                    text-align: center;
                    z-index: 1000;
                    width: 80%;
                    max-width: 300px;
                    display: none;
                `;
                container.appendChild(messageBox);
            }
            
            messageBox.innerHTML = `
                <h2>${title}</h2>
                <p>${message}</p>
            `;
            messageBox.style.display = 'block';

            // Dölj meddelandefältet vid nästa spelstart
            startButton.addEventListener('click', () => {
                messageBox.style.display = 'none';
            }, { once: true });
        }


        // --- Händelselyssnare och spelinitiering ---

        // Hantera tangentbordsinmatning för ormens riktning
        function handleKeydown(event) {
            // Kontrollera att spelet är igång innan vi hanterar input
            if (!isGameStarted || isGameOver) return;
            
            const key = event.key;
            const newDirection = { x: direction.x, y: direction.y }; // Skapa en kopia av riktningen

            switch (key) {
                case 'ArrowUp':
                    if (direction.y !== 1) { newDirection.x = 0; newDirection.y = -1; }
                    break;
                case 'ArrowDown':
                    if (direction.y !== -1) { newDirection.x = 0; newDirection.y = 1; }
                    break;
                case 'ArrowLeft':
                    if (direction.x !== 1) { newDirection.x = -1; newDirection.y = 0; }
                    break;
                case 'ArrowRight':
                    if (direction.x !== -1) { newDirection.x = 1; newDirection.y = 0; }
                    break;
            }
            // Uppdatera den globala riktningsvariabeln
            direction = newDirection;
        }

        // Startknappens hanterare
        startButton.addEventListener('click', () => {
            if (!isGameStarted) {
                initializeGame();
                gameLoop = setInterval(update, gameSpeed);
                isGameStarted = true; // VIKTIG FIX: Sätt isGameStarted till true här!
                startButton.innerText = 'Spelar...';
            }
        });

        // Lägg till händelselyssnare för tangentbordsinmatning
        document.addEventListener('keydown', handleKeydown);

        // Initial installation vid fönsterladdning
        window.onload = function() {
            initializeGame();
        };

    </script>
</body>
</html>
